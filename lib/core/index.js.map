{"version":3,"sources":["core/index.js"],"names":["eventId","options","appId","store","Error","uuid","get_uuid","apiKey","accessToken","useSSL","hasOwnProperty","host","port","keepaliveTimeout","headers","remote","wsOptions","version","set","current_uuid","get","websocket","_get_pubsub_url","logger","console","connect","ssl","apikey","base","stringify","at","api","appOptions","_get_options","path","cb","apiUrl","_get_api_url","params","then","catch","err","c","messages"],"mappings":"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","file":"index.js","sourcesContent":["import querystring from 'querystring';\nimport gen_uuid from 'uuid';\nimport packageJSON from '../../package.json';\nimport Pubsub from './pubsub';\nimport Remote from './remote';\nimport DataStore from './datastore';\n\nvar eventId = 0;\nexport default class {\n\tconstructor(options) {\n\t\tthis.options = options;\n\t\tthis.appId = options.appId;\n\t\tthis.store = options.store;\n\t\tif(!this.appId) throw new Error('appId required');\n\t\tif(!this.store) throw new Error('store required');\n\t\tthis.uuid = this.get_uuid(options.uuid);\n\t\tthis.apiKey = options.apiKey;\n\t\tthis.accessToken = options.accessToken;\n\t\tthis.useSSL = options.hasOwnProperty('useSSL') ? options.useSSL : true;\n\t\tthis.host = options.host || 'pubsub1.mlkcca.com';\n\t\tthis.port = options.port || 443;\n\t\tthis.keepaliveTimeout = options.keepaliveTimeout || 300;\n\t\tlet headers = {};\n\t\tif(this.accessToken) headers['Authorization'] = \"Bearer \" + this.accessToken;\n\t\tthis.remote = new Remote(this.host, this.port, this.useSSL, headers);\n\t\tthis.wsOptions = {\n\t\t\theaders: headers\n\t\t}\n\t}\n\n\tversion() {\n\t\treturn packageJSON.version;\n\t}\n\n\tgetAppId() {\n\t\treturn this.appId;\n\t}\n\n\tget_uuid(uuid) {\n\t\tif(uuid) {\n\t\t\tthis.store.set('uuid', uuid);\n\t\t}else{\n\t\t\tlet current_uuid = this.store.get('uuid', uuid);\n\t\t\tif(current_uuid) {\n\t\t\t\tuuid = current_uuid;\n\t\t\t}else{\n\t\t\t\tuuid = gen_uuid();\n\t\t\t\tthis.store.set('uuid', uuid);\n\t\t\t}\n\t\t}\n\t\treturn uuid;\n\t}\n\n\tconnect() {\n\t\tthis.websocket = new Pubsub({\n\t\t\thost: this._get_pubsub_url(this.useSSL, this.host, this.port, this.appId, this.apiKey, this.accessToken, this.uuid),\n\t\t\tlogger: console,\n\t\t\twsOptions: this.wsOptions\n\t\t});\n\t\tthis.websocket.connect();\n\t}\n\n\t_get_pubsub_url(ssl, host, port, appId, apikey, accessToken, uuid) {\n\n\t\tlet base = `ws${ssl?'s':''}://${host}:${port}/ws2/${appId}/`;\n\t\tif(apikey) return base + apikey + '?' + querystring.stringify({uuid:uuid})\n\t\telse if(accessToken) return base + '?' + querystring.stringify({at:accessToken, uuid:uuid})\n\t\telse return base + '?' + querystring.stringify({uuid:uuid})\n\t}\n\n\t_get_api_url(api) {\n\t\tlet appOptions = this._get_options();\n\t\tif(appOptions.apiKey) return `/api/${api}/${appOptions.appId}/${appOptions.apiKey}`;\n\t\telse return `/api/${api}/${appOptions.appId}`;\n\t}\n\n\t_get_pubsub() {\n\t\treturn this.websocket;\n\t}\n\n\t_get_remote() {\n\t\treturn this.remote;\n\t}\n\n\t_get_options() {\n\t\treturn this.options;\n\t}\n\n\tdataStore(path, options) {\n\t\treturn new DataStore(this, path, options);\n\t}\n\n\tgrant(options, cb) {\n\t\tlet apiUrl = this._get_api_url('grant');\n\t\tlet params = {};\n\t\tthis.remote.get(apiUrl, params).then(function(accessToken) {\n\t\t\tcb(null, accessToken);\n\t\t}).catch(function(err) {\n\t\t\tcb(err);\n\t\t});\n\n\t}\n\n\tstatic history(options, cb) {\n\t\tlet appId = options.appId;\n\t\tlet apiKey = options.apiKey;\n\t\tlet useSSL = options.hasOwnProperty('useSSL') ? options.useSSL : true;\n\t\tlet host = options.host || 'pubsub1.mlkcca.com';\n\t\tlet port = options.port || 443;\n\t\tvar remote = new Remote(host, port, useSSL, {});\n\t\tremote.get(`/api/history/${appId}/${apiKey}`, {c:options.path}).then(function(messages) {\n\t\t\tcb(null, messages);\n\t\t}).catch(function(err) {\n\t\t\tcb(err);\n\t\t});\n\t}\n\n\tstatic grant() {\n\n\t}\n}"]}