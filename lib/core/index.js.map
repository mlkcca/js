{"version":3,"sources":["core/index.js"],"names":["eventId","options","appId","store","Error","uuid","apiKey","accessToken","useSSL","hasOwnProperty","host","port","keepaliveTimeout","headers","remote","wsOptions","version","websocket","_get_pubsub_url","logger","console","connect","ssl","apikey","api","appOptions","_get_options","path","cb","apiUrl","_get_api_url","params","get","then","catch","err","c","messages"],"mappings":";;;;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;AAEA,IAAIA,UAAU,CAAd;;;AAEC,iBAAYC,OAAZ,EAAqB;AAAA;;AACpB,OAAKA,OAAL,GAAeA,OAAf;AACA,OAAKC,KAAL,GAAaD,QAAQC,KAArB;AACA,OAAKC,KAAL,GAAaF,QAAQE,KAArB;AACA,MAAG,CAAC,KAAKD,KAAT,EAAgB,MAAM,IAAIE,KAAJ,CAAU,gBAAV,CAAN;AAChB,MAAG,CAAC,KAAKD,KAAT,EAAgB,MAAM,IAAIC,KAAJ,CAAU,gBAAV,CAAN;AAChB,OAAKC,IAAL,GAAYJ,QAAQI,IAApB;AACA,OAAKC,MAAL,GAAcL,QAAQK,MAAtB;AACA,OAAKC,WAAL,GAAmBN,QAAQM,WAA3B;AACA,OAAKC,MAAL,GAAcP,QAAQQ,cAAR,CAAuB,QAAvB,IAAmCR,QAAQO,MAA3C,GAAoD,IAAlE;AACA,OAAKE,IAAL,GAAYT,QAAQS,IAAR,IAAgB,oBAA5B;AACA,OAAKC,IAAL,GAAYV,QAAQU,IAAR,IAAgB,GAA5B;AACA,OAAKC,gBAAL,GAAwBX,QAAQW,gBAAR,IAA4B,GAApD;AACA,MAAIC,UAAU,EAAd;AACA,MAAG,KAAKN,WAAR,EAAqBM,QAAQ,eAAR,IAA2B,YAAY,KAAKN,WAA5C;AACrB,OAAKO,MAAL,GAAc,qBAAW,KAAKJ,IAAhB,EAAsB,KAAKC,IAA3B,EAAiC,KAAKH,MAAtC,EAA8CK,OAA9C,CAAd;AACA,OAAKE,SAAL,GAAiB;AAChBF,YAASA;AADO,GAAjB;AAGA;;;;4BAES;AACT,UAAO,kBAAYG,OAAnB;AACA;;;6BAEU;AACV,UAAO,KAAKd,KAAZ;AACA;;;4BAES;AACT,QAAKe,SAAL,GAAiB,qBAAW;AAC3BP,UAAM,KAAKQ,eAAL,CAAqB,KAAKV,MAA1B,EAAkC,KAAKE,IAAvC,EAA6C,KAAKC,IAAlD,EAAwD,KAAKT,KAA7D,EAAoE,KAAKI,MAAzE,EAAiF,KAAKD,IAAtF,CADqB;AAE3Bc,YAAQC,OAFmB;AAG3BL,eAAW,KAAKA;AAHW,IAAX,CAAjB;AAKA,QAAKE,SAAL,CAAeI,OAAf;AACA;;;kCAEeC,G,EAAKZ,I,EAAMC,I,EAAMT,K,EAAOqB,M,EAAQlB,I,EAAM;AACrD,OAAGkB,MAAH,EAAW,eAAYD,MAAI,GAAJ,GAAQ,EAApB,YAA4BZ,IAA5B,SAAoCC,IAApC,aAAgDT,KAAhD,SAAyDqB,MAAzD,cAAwElB,IAAxE,CAAX,KACK,eAAYiB,MAAI,GAAJ,GAAQ,EAApB,YAA4BZ,IAA5B,SAAoCC,IAApC,aAAgDT,KAAhD,cAA8DG,IAA9D;AACL;;;+BAEYmB,G,EAAK;AACjB,OAAIC,aAAa,KAAKC,YAAL,EAAjB;AACA,OAAGD,WAAWnB,MAAd,EAAsB,iBAAekB,GAAf,SAAsBC,WAAWvB,KAAjC,SAA0CuB,WAAWnB,MAArD,CAAtB,KACK,iBAAekB,GAAf,SAAsBC,WAAWvB,KAAjC;AACL;;;gCAEa;AACb,UAAO,KAAKe,SAAZ;AACA;;;gCAEa;AACb,UAAO,KAAKH,MAAZ;AACA;;;iCAEc;AACd,UAAO,KAAKb,OAAZ;AACA;;;4BAES0B,I,EAAM1B,O,EAAS;AACxB,UAAO,wBAAc,IAAd,EAAoB0B,IAApB,EAA0B1B,OAA1B,CAAP;AACA;;;wBAEKA,O,EAAS2B,E,EAAI;AAClB,OAAIC,SAAS,KAAKC,YAAL,CAAkB,OAAlB,CAAb;AACA,OAAIC,SAAS,EAAb;AACA,QAAKjB,MAAL,CAAYkB,GAAZ,CAAgBH,MAAhB,EAAwBE,MAAxB,EAAgCE,IAAhC,CAAqC,UAAS1B,WAAT,EAAsB;AAC1DqB,OAAG,IAAH,EAASrB,WAAT;AACA,IAFD,EAEG2B,KAFH,CAES,UAASC,GAAT,EAAc;AACtBP,OAAGO,GAAH;AACA,IAJD;AAMA;;;0BAEclC,O,EAAS2B,E,EAAI;AAC3B,OAAI1B,QAAQD,QAAQC,KAApB;AACA,OAAII,SAASL,QAAQK,MAArB;AACA,OAAIE,SAASP,QAAQQ,cAAR,CAAuB,QAAvB,IAAmCR,QAAQO,MAA3C,GAAoD,IAAjE;AACA,OAAIE,OAAOT,QAAQS,IAAR,IAAgB,oBAA3B;AACA,OAAIC,OAAOV,QAAQU,IAAR,IAAgB,GAA3B;AACA,OAAIG,SAAS,qBAAWJ,IAAX,EAAiBC,IAAjB,EAAuBH,MAAvB,EAA+B,EAA/B,CAAb;AACAM,UAAOkB,GAAP,mBAA2B9B,KAA3B,SAAoCI,MAApC,EAA8C,EAAC8B,GAAEnC,QAAQ0B,IAAX,EAA9C,EAAgEM,IAAhE,CAAqE,UAASI,QAAT,EAAmB;AACvFT,OAAG,IAAH,EAASS,QAAT;AACA,IAFD,EAEGH,KAFH,CAES,UAASC,GAAT,EAAc;AACtBP,OAAGO,GAAH;AACA,IAJD;AAKA;;;0BAEc,CAEd","file":"index.js","sourcesContent":["import packageJSON from '../../package.json';\nimport Pubsub from './pubsub';\nimport Remote from './remote';\nimport DataStore from './datastore';\n\nvar eventId = 0;\nexport default class {\n\tconstructor(options) {\n\t\tthis.options = options;\n\t\tthis.appId = options.appId;\n\t\tthis.store = options.store;\n\t\tif(!this.appId) throw new Error('appId required');\n\t\tif(!this.store) throw new Error('store required');\n\t\tthis.uuid = options.uuid;\n\t\tthis.apiKey = options.apiKey;\n\t\tthis.accessToken = options.accessToken;\n\t\tthis.useSSL = options.hasOwnProperty('useSSL') ? options.useSSL : true;\n\t\tthis.host = options.host || 'pubsub1.mlkcca.com';\n\t\tthis.port = options.port || 443;\n\t\tthis.keepaliveTimeout = options.keepaliveTimeout || 300;\n\t\tlet headers = {};\n\t\tif(this.accessToken) headers['Authorization'] = \"Bearer \" + this.accessToken;\n\t\tthis.remote = new Remote(this.host, this.port, this.useSSL, headers);\n\t\tthis.wsOptions = {\n\t\t\theaders: headers\n\t\t}\n\t}\n\n\tversion() {\n\t\treturn packageJSON.version;\n\t}\n\n\tgetAppId() {\n\t\treturn this.appId;\n\t}\n\n\tconnect() {\n\t\tthis.websocket = new Pubsub({\n\t\t\thost: this._get_pubsub_url(this.useSSL, this.host, this.port, this.appId, this.apiKey, this.uuid),\n\t\t\tlogger: console,\n\t\t\twsOptions: this.wsOptions\n\t\t});\n\t\tthis.websocket.connect();\n\t}\n\n\t_get_pubsub_url(ssl, host, port, appId, apikey, uuid) {\n\t\tif(apikey) return `ws${ssl?'s':''}://${host}:${port}/ws2/${appId}/${apikey}?uuid=${uuid}`;\n\t\telse return `ws${ssl?'s':''}://${host}:${port}/ws2/${appId}?uuid=${uuid}`;\n\t}\n\n\t_get_api_url(api) {\n\t\tlet appOptions = this._get_options();\n\t\tif(appOptions.apiKey) return `/api/${api}/${appOptions.appId}/${appOptions.apiKey}`;\n\t\telse return `/api/${api}/${appOptions.appId}`;\n\t}\n\n\t_get_pubsub() {\n\t\treturn this.websocket;\n\t}\n\n\t_get_remote() {\n\t\treturn this.remote;\n\t}\n\n\t_get_options() {\n\t\treturn this.options;\n\t}\n\n\tdataStore(path, options) {\n\t\treturn new DataStore(this, path, options);\n\t}\n\n\tgrant(options, cb) {\n\t\tlet apiUrl = this._get_api_url('grant');\n\t\tlet params = {};\n\t\tthis.remote.get(apiUrl, params).then(function(accessToken) {\n\t\t\tcb(null, accessToken);\n\t\t}).catch(function(err) {\n\t\t\tcb(err);\n\t\t});\n\n\t}\n\n\tstatic history(options, cb) {\n\t\tlet appId = options.appId;\n\t\tlet apiKey = options.apiKey;\n\t\tlet useSSL = options.hasOwnProperty('useSSL') ? options.useSSL : true;\n\t\tlet host = options.host || 'pubsub1.mlkcca.com';\n\t\tlet port = options.port || 443;\n\t\tvar remote = new Remote(host, port, useSSL, {});\n\t\tremote.get(`/api/history/${appId}/${apiKey}`, {c:options.path}).then(function(messages) {\n\t\t\tcb(null, messages);\n\t\t}).catch(function(err) {\n\t\t\tcb(err);\n\t\t});\n\t}\n\n\tstatic grant() {\n\n\t}\n}"]}