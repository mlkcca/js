{"version":3,"sources":["core/datastore.js"],"names":["root","path","_options","options","setDataType","datatype","cache","Error","event","cb","onComplete","_get_pubsub","subscribe","message","decode","value","publish","apiUrl","_get_api_url","params","c","limit","order","ts","messages","useCache","query","_get_remote","get","then","add","map","m","catch","err"],"mappings":"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","file":"datastore.js","sourcesContent":["import PushDataType from './datatypes/push';\nimport SendDataType from './datatypes/send';\nimport Cache from '../cache';\n\nexport default class {\n\tconstructor(root, path, _options) {\n\t\tthis.root = root;\n\t\tthis.path = path;\n\t\tlet options = _options || {};\n\t\tthis.setDataType(options.datatype || 'json');\n\t\tthis.cache = new Cache();\n\t}\n\n\tsetDataType(datatype) {\n\t\tif(datatype != 'text' && datatype != 'json' && datatype == 'binary') {\n\t\t\tthrow new Error('invalid datatype');\n\t\t}\n\t\tthis.datatype = datatype;\n\t}\n\n\ton(event, cb, onComplete) {\n\t\tif(event == 'push') {\n\t\t\tthis.root._get_pubsub().subscribe(this.path, '_p', (message) => {\n\t\t\t\tcb(PushDataType.decode(message, this.datatype));\n\t\t\t}, onComplete);\n\t\t}else if(event == 'send') {\n\t\t\tthis.root._get_pubsub().subscribe(this.path, '_s', (message) => {\n\t\t\t\tcb(SendDataType.decode(message, this.datatype));\n\t\t\t}, onComplete);\n\t\t}\n\t}\n\n\tpush(value, options, cb) {\n\t\tif(typeof options === 'function') {\n\t\t\tcb = options;\n\t\t}\n\t\tthis.root._get_pubsub().publish(this.path, '_p', value, cb);\n\t}\n\n\tsend(value, cb) {\n\t\tthis.root._get_pubsub().publish(this.path, '_s', value, cb);\n\t}\n\n\thistory(options, cb) {\n\t\tlet apiUrl = this.root._get_api_url('history');\n\t\tlet params = {\n\t\t\tc:this.path\n\t\t}\n\t\tparams.limit = options.limit || 100;\n\t\tparams.order = options.order || 'desc'\n\t\tif(options.ts) {\n\t\t\tparams.ts = options.ts;\n\t\t}\n\n\t\tlet messages = null;\n\n\t\tif(options.useCache && options.ts && params.order == 'desc') {\n\t\t\tmessages = this.cache.query(options.ts, params.limit)\n\t\t}\n\n\t\tif(messages !== null) {\n\t\t\tcb(null, messages);\n\t\t}else{\n\t\t\tthis.root._get_remote().get(apiUrl, params).then((messages) => {\n\t\t\t\tif(options.useCache && options.ts && params.order == 'desc') {\n\t\t\t    \tthis.cache.add(options.ts, messages);\n\t\t\t\t}\n\t\t\t\tcb(null, messages.map((m)=>PushDataType.decode(m, this.datatype)));\n\t\t\t}).catch(function(err) {\n\t\t\t\tcb(err);\n\t\t\t});\n\t\t}\n\t}\n\n}\n"]}