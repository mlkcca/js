{"version":3,"sources":["core/datastore.js"],"names":["root","path","_options","options","setDataType","datatype","cache","Error","event","cb","onComplete","_get_pubsub","subscribe","message","decode","op","unsubscribe","value","publish","apiUrl","_get_api_url","params","c","limit","order","ts","id","useCache","decoded_messages","query","_get_remote","get","then","messages","map","m","length","add","catch","err"],"mappings":"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","file":"datastore.js","sourcesContent":["import PushDataType from './datatypes/push';\nimport SendDataType from './datatypes/send';\nimport Cache from '../cache';\n\nexport default class {\n\tconstructor(root, path, _options) {\n\t\tthis.root = root;\n\t\tthis.path = path;\n\t\tlet options = _options || {};\n\t\tthis.setDataType(options.datatype || 'json');\n\t\tthis.cache = new Cache();\n\t}\n\n\tsetDataType(datatype) {\n\t\tif(datatype != 'text' && datatype != 'json' && datatype == 'binary') {\n\t\t\tthrow new Error('invalid datatype');\n\t\t}\n\t\tthis.datatype = datatype;\n\t}\n\n\ton(event, cb, onComplete) {\n\t\tif(event == 'push') {\n\t\t\tthis.root._get_pubsub().subscribe(this.path, '_p', (message) => {\n\t\t\t\tcb(PushDataType.decode(message, this.datatype));\n\t\t\t}, onComplete);\n\t\t}else if(event == 'send') {\n\t\t\tthis.root._get_pubsub().subscribe(this.path, '_s', (message) => {\n\t\t\t\tcb(SendDataType.decode(message, this.datatype));\n\t\t\t}, onComplete);\n\t\t}\n\t}\n\n\toff(event, cb) {\n\t\tlet op = '_p';\n\t\tif(event == 'push') op = '_p';\n\t\telse if(event == 'send') op = '_s';\n\t\tthis.root._get_pubsub().unsubscribe(this.path, op, cb);\n\t}\n\n\tpush(value, options, cb) {\n\t\tif(typeof options === 'function') {\n\t\t\tcb = options;\n\t\t}\n\t\tthis.root._get_pubsub().publish(this.path, '_p', value, cb);\n\t}\n\n\tsend(value, cb) {\n\t\tthis.root._get_pubsub().publish(this.path, '_s', value, cb);\n\t}\n\n\thistory(options, cb) {\n\t\tlet apiUrl = this.root._get_api_url('history');\n\t\tlet params = {\n\t\t\tc:this.path\n\t\t}\n\t\tparams.limit = options.limit || 100;\n\t\tparams.order = options.order || 'desc'\n\t\tif(options.ts) {\n\t\t\tparams.id = 'd';\n\t\t\tparams.ts = options.ts;\n\t\t}\n\n\t\tif(options.useCache && options.ts && params.order == 'desc') {\n\t\t\tlet decoded_messages = this.cache.query(options.ts, params.limit)\n\t\t\tif(decoded_messages) {\n\t\t\t\tcb(null, decoded_messages);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tthis.root._get_remote().get(apiUrl, params).then((messages) => {\n\t\t\tlet decoded_messages = messages.map((m)=>PushDataType.decode(m, this.datatype));\n\t\t\tif(options.useCache && options.ts && params.order == 'desc' && messages.length > 0) {\n\t\t    \tthis.cache.add(options.ts, decoded_messages);\n\t\t\t}\n\t\t\tcb(null, decoded_messages);\n\t\t}).catch(function(err) {\n\t\t\tcb(err);\n\t\t});\n\t}\n\n}\n"]}