{"version":3,"sources":["core/datastore.js"],"names":["root","path","_options","options","setDataType","datatype","cache","Error","event","cb","onComplete","_get_pubsub","subscribe","message","decode","op","unsubscribe","value","publish","err","id","_id","apiUrl","_get_api_url","params","c","limit","order","ts","useCache","decoded_messages","query","_get_remote","get","then","result","messages","content","map","m","length","add","catch"],"mappings":"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","file":"datastore.js","sourcesContent":["import PushDataType from './datatypes/push';\nimport SendDataType from './datatypes/send';\nimport Cache from '../cache';\n\nexport default class {\n\tconstructor(root, path, _options) {\n\t\tthis.root = root;\n\t\tthis.path = path;\n\t\tlet options = _options || {};\n\t\tthis.setDataType(options.datatype || 'json');\n\t\tthis.cache = new Cache();\n\t}\n\n\tsetDataType(datatype) {\n\t\tif(datatype != 'text' && datatype != 'json' && datatype == 'binary') {\n\t\t\tthrow new Error('invalid datatype');\n\t\t}\n\t\tthis.datatype = datatype;\n\t}\n\n\ton(event, cb, onComplete) {\n\t\tif(event == 'push') {\n\t\t\tthis.root._get_pubsub().subscribe(this.path, 'push', (message) => {\n\t\t\t\tcb(PushDataType.decode(message, this.datatype));\n\t\t\t}, onComplete);\n\t\t}else if(event == 'set') {\n\t\t\tthis.root._get_pubsub().subscribe(this.path, 'set', (message) => {\n\t\t\t\tcb(PushDataType.decode(message, this.datatype));\n\t\t\t}, onComplete);\n\t\t}else if(event == 'send') {\n\t\t\tthis.root._get_pubsub().subscribe(this.path, 'send', (message) => {\n\t\t\t\tcb(SendDataType.decode(message, this.datatype));\n\t\t\t}, onComplete);\n\t\t}\n\t}\n\n\toff(event, cb) {\n\t\tlet op = '_p';\n\t\tif(event == 'push') op = '_p';\n\t\telse if(event == 'send') op = '_s';\n\t\tthis.root._get_pubsub().unsubscribe(this.path, op, cb);\n\t}\n\n\tpush(value, options, cb) {\n\t\tif(typeof options === 'function') {\n\t\t\tcb = options;\n\t\t}\n\t\tthis.root._get_pubsub().publish(this.path, 'push', value, (err, message) => {\n\t\t\tif(err) return cb(err);\n\t\t\tcb(null, PushDataType.decode(message, this.datatype))\n\t\t});\n\t}\n\n\tset(id, value, options, cb) {\n\t\tif(typeof options === 'function') {\n\t\t\tcb = options;\n\t\t}\n\t\tthis.root._get_pubsub().publish(this.path, 'set', value, cb, {_id: id});\n\t}\n\n\tsend(value, cb) {\n\t\tthis.root._get_pubsub().publish(this.path, 'send', value, cb);\n\t}\n\n\thistory(options, cb) {\n\t\tlet apiUrl = this.root._get_api_url('history');\n\t\tlet params = {\n\t\t\tc:this.path\n\t\t}\n\t\tparams.limit = options.limit || 100;\n\t\tparams.order = options.order || 'desc'\n\t\tif(options.ts) {\n\t\t\tparams.id = 'd';\n\t\t\tparams.ts = options.ts;\n\t\t}\n\n\t\tif(options.useCache && options.ts && params.order == 'desc') {\n\t\t\tlet decoded_messages = this.cache.query(options.ts, params.limit)\n\t\t\tif(decoded_messages) {\n\t\t\t\tcb(null, decoded_messages);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tthis.root._get_remote().get(apiUrl, params).then((result) => {\n\t\t\tif(result.err) {\n\t\t\t\tcb(result.err);\n\t\t\t}else{\n\t\t\t\tlet messages = result.content;\n\t\t\t\tlet decoded_messages = messages.map((m)=>PushDataType.decode(m, this.datatype));\n\t\t\t\tif(options.useCache && options.ts && params.order == 'desc' && messages.length > 0) {\n\t\t\t    \tthis.cache.add(options.ts, decoded_messages);\n\t\t\t\t}\n\t\t\t\tcb(null, decoded_messages);\n\t\t\t}\n\t\t}).catch(function(err) {\n\t\t\tcb(err);\n\t\t});\n\t}\n\n}\n"]}